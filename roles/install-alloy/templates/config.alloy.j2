// // This config file is designed to send traces and metrics to the docker
// // compose environment from example/docker-compose.
// 
// logging {
// 	level  = "debug"
// 	format = "logfmt"
// }
// 
// tracing {
// 	// Sample all traces. This value should be lower for production configs!
// 	sampling_fraction = 1
// 
// 	write_to = [otelcol.exporter.otlp.tempo.input]
// }
// 
// otelcol.exporter.otlp "tempo" {
// 	client {
// 		endpoint = "localhost:4317"
// 
// 		tls {
// 			insecure = true
// 		}
// 	}
// }
// 
// prometheus.exporter.unix "default" { /* use defaults */ }
// 
// prometheus.scrape "default" {
// 	targets    = prometheus.exporter.unix.default.targets
// 	forward_to = [prometheus.remote_write.default.receiver]
// }
// 
// prometheus.remote_write "default" {
// 	endpoint {
// 		url = "http://localhost:9009/api/prom/push"
// 	}
// }

// =================================================================
//                         Logging & Server
// =================================================================

logging {
  level = "info"
}

server {
  http_listen_address = "0.0.0.0"
  http_listen_port    = 12345
}

// =================================================================
//                           Host metadata
// =================================================================

local.file "hostname" {
  filename = "/etc/hostname"
}

// =================================================================
//                     METRICS (node-exporter-like)
// =================================================================

prometheus.exporter.unix "node" {}

prometheus.scrape "node" {
  targets    = prometheus.exporter.unix.node.targets
  scrape_interval = "15s"

  forward_to = [prometheus.remote_write.mimir.receiver]
}

prometheus.remote_write "mimir" {
  external_labels = {
    env        = "test",
    app        = "k8s",
    cluster    = "alma-k8s2",
    subsystem  = "node",
    prometheus = "alma-k8s2-node-alloy-01",
    host       = trimspace(local.file.hostname.content),
  }

  endpoint {
    url = "https://mimir.fillswim.local/api/v1/push"
  }
}

// =================================================================
//                          LOGS (systemd)
// =================================================================

loki.source.journal "systemd" {
  labels = {
    job  = "systemd",
    host = trimspace(local.file.hostname.content),
  }

  forward_to = [loki.write.loki.receiver]
}

// =================================================================
//                            LOGS (files)
// =================================================================

loki.source.file "varlogs" {
  targets = [
    { __path__ = "/var/log/*.log" },
    { __path__ = "/var/log/syslog" },
    { __path__ = "/var/log/messages" },
  ]

  labels = {
    job  = "varlogs",
    host = trimspace(local.file.hostname.content),
  }

  forward_to = [loki.write.loki.receiver]
}

// =================================================================
//                             LOKI OUTPUT
// =================================================================

loki.write "loki" {
  endpoint {
    url = "https://loki.fillswim.local/loki/api/v1/push"
  }

  external_labels = {
    env        = "test",
    app        = "k8s",
    cluster    = "alma-k8s2",
    subsystem  = "node",
    prometheus = "alma-k8s2-node-alloy-01",
    host       = trimspace(local.file.hostname.content),
  }
}
